<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>Стая</title>
<style>
body{font-family:Arial;text-align:center;padding:20px;background:#f0f4ff;}
#timer{font-size:48px;margin:20px;}
.shake{display:inline-block;animation:shake 1s infinite}
@keyframes shake{0%{transform:translate(1px,1px)rotate(0deg)}20%{transform:translate(-1px,-2px)rotate(-1deg)}40%{transform:translate(-3px,0px)rotate(1deg)}60%{transform:translate(3px,2px)rotate(0deg)}80%{transform:translate(1px,-1px)rotate(1deg)}100%{transform:translate(-1px,2px)rotate(-1deg)}}
.follow-box{margin-top:30px;padding:15px;background:#fff;border:2px solid #3399ff;border-radius:10px;display:inline-block;cursor:pointer}
.follow-box:hover{background:#eaf4ff}
#announcement-container{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1000;}
#wheelCanvas{margin-top:20px;display:none;}
#arrow{position:absolute;top:20px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:20px solid transparent;border-right:20px solid transparent;border-bottom:40px solid red;}
</style>
</head>
<body>
<h2 class="shake">Следващата игра започва след</h2>
<div id="timer">10</div>

<canvas id="wheelCanvas" width="500" height="500"></canvas>
<div id="arrow"></div>

<div class="follow-box" onclick="window.open('https://www.tiktok.com/@yoan29633','_blank')">Натисни тук, за да последваш YOAN!</div>

<div id="announcement-container"></div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');
const username = urlParams.get('username');
const ws = new WebSocket(`wss://${location.host}`);
let users = [];
let timer = 10;

ws.onopen = ()=>ws.send(JSON.stringify({type:"joinRoom",code,username}));

ws.onmessage=(msg)=>{
  const data = JSON.parse(msg.data);
  if(data.type==="userJoined") users=data.users;
  if(data.type==="announcement") showAnnouncement(data.message);
  if(data.type==="gameStart") startWheelGame(data.game);
  if(data.type==="gameWinner") alert("Победител: "+data.winner);
};

function showAnnouncement(msg){
  const ann = document.createElement("div");
  ann.textContent=msg;
  ann.style.background="#fffae6";
  ann.style.border="2px solid #ffcc00";
  ann.style.padding="10px";
  ann.style.marginTop="5px";
  ann.style.borderRadius="6px";
  document.getElementById("announcement-container").appendChild(ann);
  setTimeout(()=>ann.remove(),5000);
}

function startWheelGame(game){
  const canvas = document.getElementById("wheelCanvas");
  const ctx = canvas.getContext("2d");
  canvas.style.display="block";
  const segments = users.length;
  const anglePer = 2*Math.PI/segments;
  let startAngle = 0;
  const colors=["#ff9999","#99ff99","#9999ff","#ffcc99","#cc99ff","#99ffff"];
  
  // draw wheel
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=0;i<segments;i++){
    ctx.beginPath();
    ctx.moveTo(250,250);
    ctx.arc(250,250,200,startAngle,startAngle+anglePer);
    ctx.fillStyle=colors[i%colors.length];
    ctx.fill();
    ctx.stroke();
    ctx.save();
    ctx.translate(250,250);
    ctx.rotate(startAngle+anglePer/2);
    ctx.fillStyle="#000";
    ctx.font="16px Arial";
    ctx.fillText(users[i],110,0);
    ctx.restore();
    startAngle+=anglePer;
  }

  // spin animation
  let rotation = 0;
  let speed = 0.3+Math.random()*0.5;
  const spin = setInterval(()=>{
    rotation+=speed;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let angle = rotation;
    for(let i=0;i<segments;i++){
      ctx.beginPath();
      ctx.moveTo(250,250);
      ctx.arc(250,250,200,angle,angle+anglePer);
      ctx.fillStyle=colors[i%colors.length];
      ctx.fill();
      ctx.stroke();
      ctx.save();
      ctx.translate(250,250);
      ctx.rotate(angle+anglePer/2);
      ctx.fillStyle="#000";
      ctx.font="16px Arial";
      ctx.fillText(users[i],110,0);
      ctx.restore();
      angle+=anglePer;
    }
    speed*=0.97;
    if(speed<0.002){clearInterval(spin);}
  },16);
}

// countdown
setInterval(()=>{
  if(timer>0) timer--;
  document.getElementById("timer").textContent=timer;
},1000);
</script>
</body>
</html>
